{% extends "base.html" %}

{% block content %}
{% load static %}
<script src="{% static 'js/vendor/showdown.min.js' %}"></script>
<script src="{% static 'js/vendor/superagent.min.js' %}"></script>
<textarea name="title" id="title" cols="30" rows="1">Loading</textarea>
<div class='grid-x'>
    <div class='cell small-6'>
        <textarea name="textarea" id="editor" cols="80" rows="30">Loading...</textarea>
    </div>
    <div class='cell small-6'>
        <button type='button' class='button' style='float: right;' onclick=saveAndRedirect()>Save Changes</button>
        <span id='renderer'></span>
    </div>
</div>

<script>
    var showdown = new showdown.Converter();
    var pathlist = window.location.pathname.split('/');

    var sock = new WebSocket("ws://localhost:8000/ws/" + window.location.pathname.split('/').join(''));

    sock.onmessage = function(e) {
        var elem = document.getElementById("editor");
        if (JSON.parse(e['data'])['code'] === 'conn') {
            sock.send(elem.value);
        } else {
            elem.value = JSON.parse(e['data'])['message'];
        }
        var elem = document.getElementById("editor");
        var elem2 = document.getElementById("renderer");
        elem2.innerHTML = showdown.makeHtml(elem.value);
    }

    function syncText() {
        var elem = document.getElementById("editor");
        sock.send(elem.value);
        var elem2 = document.getElementById("renderer");
        elem2.innerHTML = showdown.makeHtml(elem.value);
    }

    function render() {
        var elem = document.getElementById("editor");
        var elem2 = document.getElementById("renderer");
        elem2.innerHTML = showdown.makeHtml(elem.value);
    }

    var elem = document.getElementById("editor");
    elem.addEventListener('input', syncText);

    superagent.get('/api/topic/' + window.location.pathname.split('/')[3]).end((err, resp) => {
        if (err) {
            console.log(err)
        };
        var mod = JSON.parse(resp['text'])['topicBody'];
        var elem = document.getElementById("editor");
        elem.value = mod;
        elem = document.getElementById("title");
        elem.value = JSON.parse(resp['text'])['topicTitle'];
        render();
    });
    render();

    function saveAndRedirect() {
        var loc = window.location.pathname.split('/')[3];
        console.log('api/topic/' + loc)
        superagent.post('/api/topic/' + loc).set('X-CSRFToken', '{{csrf_token}}').send({
            'topicBody' : document.getElementById('editor').value,
            'topicTitle' : encodeURI(document.getElementById('title').value)
        
        }).type('form').then( (err, resp) => {
            if (err) {
                console.log(err);
            }
            window.location = '/att/' + encodeURI(document.getElementById('title').value);
        });

    }
</script>

{% endblock %}